# Comment Threading Investigation - Progress Log

## Problem Statement

Threaded comments (parent + replies) generated by docxfix do not always appear as threaded conversations in Microsoft Word. Some work, many don't. We need to identify what makes Word recognize comments as threaded.

---

## What We've Tried

### 1. Initial Fix: Interleaved Range Ends and References
**Issue:** Comment ranges and references were batched instead of interleaved.

**Change Made:** Modified `comments.py` to interleave `commentRangeEnd` and `commentReference` elements:
- Before: All ends together, then all references
- After: Parent end, parent ref, reply1 end, reply1 ref, etc.

**Result:** Partial improvement, but many cases still fail.

### 2. Added Date Attributes to Comments
**Issue:** Missing `w:date` attribute on `<w:comment>` elements.

**Change Made:** Added date formatting to comments.xml generation.

**Result:** No significant change in threading behavior.

### 3. Fixed Initials Extraction
**Issue:** Initials were only first character (e.g., "D" instead of "DM" for "David Murray").

**Change Made:** Extract initials from full name by taking first letter of each word.

**Result:** No change in threading behavior.

### 4. Fixed Paragraph Text Duplication Bug
**Issue:** Multiple comments on same paragraph caused text duplication because we were rebuilding paragraph for each comment.

**Change Made:** Complete rewrite of `add_paragraph_with_comments()` to:
- Collect all comments and their positions
- Sort by position
- Build paragraph once with interleaved comments

**Result:** Fixed some cases, but threading still fails in many scenarios.

---

## Test Results Summary

### ✅ WORKING Cases

| Document | Case | Description |
|----------|------|-------------|
| debug-comments-simple-v4.docx | All cases | 1 standalone, 1 parent+1reply, 1 parent+2replies, 2 independent |
| debug-comments-complex-v4.docx | Case 5 | 1 thread (parent+reply) + 1 standalone on same paragraph |
| debug-comments-complex-v4.docx | Case 7 | Resolved parent + 2 replies (PARTIAL - only first 2 thread) |
| test-two-threads.docx | Single paragraph | 2 separate threads on one paragraph (isolated document) |
| word-paragraph-two-threads.docx | Single paragraph | Word-generated file with 2 threads (CONTROL - known working) |

### ❌ FAILING Cases

| Document | Case | Description | What We See in Word |
|----------|------|-------------|---------------------|
| debug-comments-complex-v4.docx | Case 6 | 2 separate threads on same paragraph | No threading at all (5 independent comments) |
| debug-comments-complex-v4.docx | Case 7 | Resolved parent + 2 replies | First 2 threaded, 3rd reply not threaded |
| debug-comments-complex-v4.docx | Case 8B | Parent + reply on later paragraph | No threading at all |
| word-replica-v3.docx | Para 1 | Parent + 3 replies | No threading at all |
| word-replica-v3.docx | Para 2 | Resolved parent + 2 replies | First 2 threaded, 3rd reply not threaded |
| word-two-thread-replica.docx | Single paragraph | Exact replica of Word's structure | No threading at all |

---

## Key Observations

### Pattern 1: Isolated vs. Embedded Documents
- **test-two-threads.docx** (isolated, 2 threads on 1 paragraph) → **WORKS**
- **Case 6** (same structure but in multi-paragraph document) → **FAILS**
- **word-two-thread-replica.docx** (isolated, exact Word structure) → **FAILS**

**Hypothesis:** Something about our document structure (not comment-specific) is breaking threading.

### Pattern 2: Single Reply vs. Multiple Replies
- Parent + 1 reply → Usually works
- Parent + 2 replies → Often fails on 2nd or 3rd reply
- Parent + 3 replies → Complete failure

**Hypothesis:** There may be an issue with how we're handling multiple replies in the XML structure.

### Pattern 3: Document Position
- Early paragraphs → More likely to work
- Later paragraphs → More likely to fail

**Hypothesis:** Comment ID numbering or state management issue across paragraphs.

---

## XML Structure Analysis

### What Our Generated Files Have

✅ **Correctly Generated:**
- `commentsExtended.xml` with proper `paraIdParent` attributes
- Interleaved `commentRangeEnd` and `commentReference` elements in document.xml
- `w:date` attributes on all comments
- Proper initials (e.g., "DM" for "David Murray")
- No duplicate paragraph text
- Comment IDs properly matching between files

✅ **Matches Word's Structure:**
- Exact same element ordering in document.xml
- Same threading structure in commentsExtended.xml
- Same comment attributes (id, author, date, initials)

### Structural Comparison: Word vs. Ours

Comparing `word-paragraph-two-threads.docx` (works) vs. `word-two-thread-replica.docx` (fails):

| Attribute | Word | Ours | Match? |
|-----------|------|------|--------|
| Number of comments | 5 | 5 | ✅ |
| Threading structure | 2 threads | 2 threads | ✅ |
| Comment IDs | 0,1,2,3,4 | 0,1,2,3,4 | ✅ |
| Date format | ISO 8601 | ISO 8601 | ✅ |
| Initials | "DM" | "DM" | ✅ |
| textId | 77777777 | 77777777 | ✅ |
| Element ordering | interleaved | interleaved | ✅ |
| Namespace declarations | Full set | Full set | ✅ |

**Only Differences:**
- `paraId` values (random GUIDs - expected to differ)
- Exact timestamps (expected to differ)

---

## Current Hypotheses (Unexplored)

### Hypothesis A: Document-Level Properties
The overall document structure (not comment-specific) might be missing something Word requires for threading to work. Possibilities:
- Missing relationships or content types
- Document properties or settings
- Core properties metadata

### Hypothesis B: Paragraph-Level Attributes
The paragraph elements themselves might be missing attributes that Word uses to enable threading:
- `w:rsidR`, `w:rsidRPr`, `w:rsidRDefault` (revision IDs)
- `w14:textId` values (we always use "77777777", Word uses unique values)
- Paragraph properties (`w:pPr` structure)
- Run properties (`w:rPr` attributes like `w:noProof`, `w:lang`)

### Hypothesis C: Comments.xml Ordering
Word might require comments to be ordered in a specific way within comments.xml (e.g., parent before replies, or in document order).

### Hypothesis D: CommentsIds.xml Issue
We generate commentsIds.xml with durableId values, but haven't verified this matches Word's expectations.

---

## Next Steps

### Immediate Investigation Needed
1. **Compare document-level structure:** Extract and compare ALL files from Word's working document vs. our failing replica
2. **Test paragraph attributes:** Add Word's paragraph-level attributes (rsidR, lang, etc.) to our generated paragraphs
3. **Test with unique textId values:** Stop using "77777777" for all paragraphs
4. **Progressive modification test:** Start with Word's working file, progressively modify it to match ours, find breaking point

### Critical Questions to Answer
1. Why does `test-two-threads.docx` work in isolation but `word-two-thread-replica.docx` (exact same structure) fails?
2. What is the minimal difference between Word's working file and our failing replica?
3. Is there a document-level setting or property that controls threading?

---

## Files for Analysis

### Working (Generated by Word)
- `word-threaded-comments.docx` - 2 paragraphs, multiple replies per thread
- `word-paragraph-two-threads.docx` - Single paragraph, 2 threads

### Failing (Generated by docxfix)
- `word-replica-v3.docx` - Attempted replica of word-threaded-comments.docx
- `word-two-thread-replica.docx` - Attempted replica of word-paragraph-two-threads.docx
- `debug-comments-complex-v4.docx` - Multiple test cases, many failing

### Partially Working (Generated by docxfix)
- `debug-comments-simple-v4.docx` - All cases work
- `test-two-threads.docx` - Isolated 2-thread case, works perfectly

---

## Code Changes Made

### src/docxfix/parts/comments.py
1. Line 129-146: Interleaved comment range ends and references
2. Line 170-186: Added date attribute and proper initials extraction
3. Line 76-178: Complete rewrite of `add_paragraph_with_comments()` to fix text duplication

All changes verified by test suite (199 tests passing).

---

## Critical Discovery (2026-02-21T10:22)

**BREAKTHROUGH:** Comparison of ZIP file contents revealed Word includes files we don't generate:

### Missing Files That May Be Critical

1. **`word/commentsExtensible.xml`** ⚠️ **MISSING - LIKELY REQUIRED**
   - Contains `<w16cex:commentExtensible>` elements
   - One per comment with `durableId` and `dateUtc` attributes
   - Example: `<w16cex:commentExtensible w16cex:durableId="34FDF105" w16cex:dateUtc="2026-02-21T10:04:00Z"/>`

2. **`word/people.xml`** ⚠️ **MISSING - MAY BE REQUIRED**
   - Contains `<w15:person>` elements for authors
   - Includes provider/user ID information
   - Example: `<w15:person w15:author="David Murray"><w15:presenceInfo w15:providerId="Windows Live" w15:userId="e9641994587f67f1"/></w15:person>`

3. **`word/commentsIds.xml`** - We have code for this but may not be including it

### Hypothesis E: Missing Comment Support Files
Word's modern threaded comments require BOTH `commentsExtended.xml` (which we generate) AND `commentsExtensible.xml` (which we don't). The extensible file may contain metadata that Word needs to properly thread comments.

---

## Deep Analysis Session (2026-02-21T16:42)

### Structural Comparison: v4 (works) vs v5/v6 (fails)

Detailed binary/XML analysis of `debug-comments-simple-v4.docx` (works) vs v5/v6 (fails):

| Property | v4 | v5 | v6 |
|----------|----|----|-----|
| ZIP entries | Identical | Identical | Identical |
| document.xml structure (normalized) | Base | Same | Same |
| commentsExtended.xml structure (normalized) | Base | Same | Same |
| comments.xml structure (normalized) | Base | Same | Same |
| settings.xml content | Identical | Identical | Identical |
| docId | `4D55359B` | `4D55359B` | `4D55359B` |
| Specific paraId values | Different random | Different random | Different random |
| Timestamps in comments.xml | 11:05:14 | 15:42:50 | 16:47:01 |

**KEY FINDING: v4 and v6 are structurally identical after normalizing IDs; the only difference is timestamps. Yet v4 works and v6 fails.**

### Timing Analysis

All files with docId `4D55359B` ordered by creation time:
1. `test-two-threads.docx` (11:02) → **WORKS**
2. `debug-comments-simple-v4.docx` (11:05) → **WORKS**
3. `word-two-thread-replica.docx` (11:15) → **FAILS**
4. `word-two-thread-replica-v2.docx` (12:06) → **FAILS** (assumed)
5. `word-two-thread-replica-v3.docx` (12:15) → **FAILS** (assumed)
6. `debug-comments-complex-v5.docx` (12:15) → **FAILS** (assumed)
7. `test-id0-workaround.docx` (15:39) → unknown
8. `debug-comments-simple-v5.docx` (15:42) → **FAILS**
9. `debug-comments-simple-v6.docx` (16:47) → **FAILS**

**Pattern: Only the EARLIEST files (11:02–11:05) work. ALL files generated after 11:15 fail. This is consistent with a session or cache-based issue.**

### The Hardcoded docId Problem

All our generated files share the **same hardcoded `w14:docId w14:val="4D55359B"`** from the SETTINGS_XML constant in boilerplate.py. Word uses docId to uniquely identify documents across sessions. This may cause Word to confuse documents that share the same docId.

### Hypothesis F: docId Caching
Word associates comment threading state with `w14:docId`. The first document with this docId is processed correctly (establishing the threading state). Subsequent documents with the same docId but different paraIds either:
- Fail to match the cached threading state and fall back to flat display
- Or trigger some conflict in Word's internal comment tracking state

**Supporting evidence:** All working files were opened before any failing files. All share the same docId.

### What the Corpus File Shows

`corpus/comment-thread.docx` (Word-generated, works) has `commentsIds.xml` WITH a proper relationship (`rId8`, type `http://schemas.microsoft.com/office/2016/09/relationships/commentsIds`). This file was generated by Word and has a unique docId.

We previously REMOVED `commentsIds.xml` from our generation (commit e1dcc4e, 2026-02-17) based on the hypothesis that it was causing threading failures. But the corpus file proves Word-generated files WITH `commentsIds.xml` work correctly.

### Hypothesis G: commentsIds.xml Wiring
Our previous attempt at commentsIds.xml may have had an incorrect relationship type or content type, making it confuse Word rather than help it. The correct relationship type is `http://schemas.microsoft.com/office/2016/09/relationships/commentsIds` (not what we had before).

---

## Experiments Generated (2026-02-21T16:58)

Four test documents generated in `scratch_out/` to test Hypotheses F and G:

| File | docId | commentsIds? | Tests |
|------|-------|--------------|-------|
| `exp0-baseline.docx` | `4D55359B` (shared) | No | Control (like v5) |
| `exp1-unique-docid.docx` | `75289D34` (unique) | No | Hypothesis F only |
| `exp2-with-commentsids.docx` | `4D55359B` (shared) | Yes | Hypothesis G only |
| `exp3-unique-docid-with-commentsids.docx` | `051A0E9F` (unique) | Yes | Both F and G |

**To test:** Open each file in Word and verify whether Cases 2, 3 show threaded comments.
Expected result if Hypothesis F is correct: exp1 and exp3 will work, exp0 and exp2 may fail.
Expected result if Hypothesis G is correct: exp2 and exp3 will work, exp0 and exp1 may fail.

---

## Experiment Results (exp0–exp3)

| File | docId | commentsIds? | Result |
|------|-------|--------------|--------|
| `exp0-baseline.docx` | `4D55359B` (shared) | No | ❌ ALL separate |
| `exp1-unique-docid.docx` | `75289D34` (unique) | No | ❌ ALL separate |
| `exp2-with-commentsids.docx` | `4D55359B` (shared) | Yes | ❌ ALL separate |
| `exp3-unique-docid-with-commentsids.docx` | `051A0E9F` (unique) | Yes | ⚠️ PARTIAL: Cases 1,3,4 correct; Case 2 (1 reply) FAILS |

**Key reminder:** v4 (shared docId `4D55359B`, NO commentsIds) works. exp0 (same config, different random paraIds) fails. This confirms the **specific paraId values matter** — or timing/caching.

### Analysis: Why does Case 2 fail in exp3?

Both Case 2 (parent + 1 reply) and Case 3 (parent + 2 replies) have the same XML structure, same `durableId = paraId` for parents. The only structural difference: thread size.

In exp3 commentsIds.xml:
- Case 2 parent: `paraId=BAF52693`, `durableId=BAF52693` (same — the "bug")
- Case 2 reply:  `paraId=662F7161`, `durableId=3183A51B` (different — correct)
- Case 3 parent: `paraId=47ABBF98`, `durableId=47ABBF98` (same — same bug!)
- Case 3 reply1: `paraId=1D1330EC`, `durableId=B55E2150`
- Case 3 reply2: `paraId=64F5F1C2`, `durableId=706E2210`

Since both Case 2 and Case 3 have `durableId = paraId` for parents, **the durableId bug is NOT the distinguishing factor for Case 2 failure**.

Remaining hypotheses for Case 2 failure:
- **H1 (structure):** Word requires ≥2 replies to recognize a thread (thread size < 3 fails)
- **H2 (position):** Case 2 is at a specific position (2nd thread) that Word mishandles
- **H3 (interference):** The surrounding comments interfere with Case 2's threading

---

## Experiments Generated (2026-02-21, second batch)

Four test documents generated to isolate Case 2 failure:

| File | Config | Tests |
|------|--------|-------|
| `exp4-case2-isolation.docx` | Unique docId + commentsIds, ONLY Case 2 | Is Case 2 failure structural or context-dependent? |
| `exp5-cases-swapped.docx` | Unique docId + commentsIds, Cases 2 & 3 swapped | Is failure position-dependent vs structure-dependent? |
| `exp6-unique-durable-ids.docx` | Unique docId + commentsIds, unique durableId for ALL | Does fixing durableId=paraId bug fix Case 2? |
| `exp7-unique-docid-no-commentsids.docx` | Unique docId, NO commentsIds (like v4) | Does unique docId alone work? |

**Reading the results:**
- exp4 fails → structural issue (1 reply is always broken); exp4 works → context was interfering
- exp5: Case 3's structure fails in position 2 → position-dependent; Case 2 still fails → structure
- exp6 fixes Case 2 → durableId was the issue (despite both Case 2 & 3 having same bug in exp3)
- exp7 works → unique docId alone is sufficient, commentsIds not needed

---

## Last Updated
2026-02-21T17:30:00Z
