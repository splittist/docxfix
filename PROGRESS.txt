## 2026-02-25 - Phase 3 M3.3: BDD Row Mapping Helper (Complete)

**What was done:**
- Implemented M3.3: BDD row mapping helper from Phase 3 PRD (FR-3.3)
- Created `src/docxfix/bdd_mapping.py`:
  - `map_row_to_spec(row, *, title, author, seed)` ‚Äî converts a BDD table row dict to a `DocumentSpec`
  - `VALID_ALIASES` ‚Äî documented dict of supported alias keys and descriptions
  - `BDDMappingError` ‚Äî raised for unknown aliases or invalid values
  - Four supported aliases: `tracked_changes`, `comment_threads`, `numbering_depth`, `use_sections`
  - Bool aliases accept `True`/`False`, `'on'`/`'off'`/`'true'`/`'false'`/`'yes'`/`'no'`
  - Int aliases accept ints or digit strings; validated for range
  - Unknown keys raise `BDDMappingError` with list of valid aliases
- Created `tests/test_bdd_mapping.py` ‚Äî 51 tests:
  - `VALID_ALIASES` structure (2 tests)
  - Empty/default row (6 tests)
  - `tracked_changes`: True/False/string variants (7 tests)
  - `comment_threads`: count, replies, anchor text, string values (6 tests)
  - `numbering_depth`: levels, counts, string values (5 tests)
  - `use_sections`: second section, header, paragraph count guarantee (6 tests)
  - Combined aliases (3 tests)
  - Unknown alias errors (3 tests)
  - Invalid values: 9 error cases
  - End-to-end: empty row, all aliases, deterministic seed, full flow (4 tests)

**Acceptance criteria met:**
- ‚úÖ Mapping helper has unit tests for happy paths and invalid aliases (51 tests)
- ‚úÖ Example shows row -> spec -> `.docx` in one flow (`test_row_to_spec_to_docx_full_flow`)

**Test totals:** 250 tests passing (51 new).

**Files added:**
- `src/docxfix/bdd_mapping.py` ‚Äî BDD row mapping helper
- `tests/test_bdd_mapping.py` ‚Äî comprehensive tests

**Files changed:**
- `docs/future-phases-prd.md` ‚Äî marked M3.3 as complete
- `PROGRESS.txt` ‚Äî this entry

**What's ready for next work:**
- M3.4: Docs/examples cleanup

---

## 2026-02-25 - Comment Threading Investigation Concluded

**Final results from experiments (exp0‚Äìexp10):**
- Every experiment file with a fresh docId fails to show threading in Word, regardless of whether commentsIds.xml is present, whether the docId is unique or shared, or whether the full docxfix structure is used.
- `debug-comments-simple-v4.docx` still threads correctly as of 2026-02-25.
- The one partial success was `exp3` on 2026-02-21 (Cases 1, 3, 4 threaded; Case 2 not) ‚Äî this may have been a transient state before Word's cache became fully populated.

**Conclusion:** Word maintains a persistent local comment-threading cache keyed by `w14:docId`. v4 works because its threading state was cached when it was first opened. We cannot reliably populate this cache programmatically. The `commentsExtended.xml` threading structure is correct per spec and renders correctly in SuperDoc; the issue is Word-specific.

**Recommendations implemented / deferred:**
- ‚úÖ Investigation documented in `docs/comment-threading-investigation.md`
- üîú Add unique `w14:docId` per document (currently hardcoded `4D55359B`) ‚Äî deferred to next phase
- üîú Hook up `commentsIds.xml` generation in the generator ‚Äî deferred to next phase
- üîú Document Word threading limitation in README/docs ‚Äî deferred to next phase

---

## 2026-02-21 - Comment Threading Regression Investigation

**Problem:** `debug-comments-simple-v4.docx` shows correct threaded comments in Word, but v5 and v6 (generated later, with same structure) show all comments as independent. SuperDoc displays all three correctly.

**Analysis performed:**
- Structural comparison of v4 vs v5 vs v6: XML structure is **identical** after normalizing random hex IDs. Only differences are the specific paraId values and timestamps.
- Timing observation: Working files (test-two-threads 11:02, v4 11:05) were all generated in a 3-minute window. **Every file generated after 11:15 fails.** This pattern strongly suggests a session/cache-based problem.
- Hardcoded `w14:docId`: ALL our generated files share the same `docId="4D55359B"` from the hardcoded SETTINGS_XML constant. Word uses docId to uniquely identify documents. This is a plausible source of confusion.
- Corpus analysis: `corpus/comment-thread.docx` (Word-generated, works) has `commentsIds.xml` with a proper relationship type `http://schemas.microsoft.com/office/2016/09/relationships/commentsIds`. We removed `commentsIds.xml` in commit e1dcc4e based on an incorrect hypothesis.

**Hypotheses under investigation:**
- **Hypothesis F (docId caching):** Word associates comment threading state with `w14:docId`. Multiple documents sharing docId `4D55359B` cause conflicts in Word's internal state after the first document is cached.
- **Hypothesis G (commentsIds.xml):** The `commentsIds.xml` file is required for reliable comment threading. Our previous removal of it may have been solving the wrong problem (perhaps it was the *incorrect relationship type* that caused the original issue).

**Experiments generated** (in `scratch_out/`):
- `exp0-baseline.docx` ‚Äî control (same as v5, shared docId, no commentsIds)
- `exp1-unique-docid.docx` ‚Äî unique docId `75289D34`, no commentsIds (tests H-F)
- `exp2-with-commentsids.docx` ‚Äî shared docId, WITH commentsIds (tests H-G)
- `exp3-unique-docid-with-commentsids.docx` ‚Äî unique docId `051A0E9F`, WITH commentsIds (tests both)

**Status:** Awaiting manual test in Word. Investigation log in `docs/comment-threading-investigation.md`.

---

## 2026-02-18 - Comment Threading Interleaving Fix

**What was done:**
- Fixed bug where threaded comments did not always appear as threads in Word
- Root cause: `commentRangeEnd` and `commentReference` elements were batched instead of interleaved
- Word requires specific ordering: parent end ‚Üí parent ref ‚Üí reply1 end ‚Üí reply1 ref ‚Üí etc.
- Previous (incorrect) structure:
  ```xml
  <commentRangeEnd id="parent"/>
  <commentRangeEnd id="reply1"/>
  <commentRangeEnd id="reply2"/>
  <commentReference id="parent"/>
  <commentReference id="reply1"/>
  <commentReference id="reply2"/>
  ```
- Fixed structure (matches Word's format):
  ```xml
  <commentRangeEnd id="parent"/>
  <commentReference id="parent"/>
  <commentRangeEnd id="reply1"/>
  <commentReference id="reply1"/>
  <commentRangeEnd id="reply2"/>
  <commentReference id="reply2"/>
  ```
- Modified `src/docxfix/parts/comments.py::add_paragraph_with_comments()` to interleave ranges and references
- Created debug examples:
  - `examples/debug-comments-simple.yaml` ‚Äî 4 basic threading scenarios with expected behavior documented in text
  - `examples/debug-comments-complex.yaml` ‚Äî 8 advanced scenarios (mixed threads, resolved comments, multiple paragraphs)
- Created inspection scripts:
  - `scripts/inspect_comments.py` ‚Äî Shows comment threading structure from commentsExtended.xml
  - `scripts/inspect_document_anchors.py` ‚Äî Shows comment anchor points in document.xml
- Added regression test:
  - `tests/test_comment_integration.py::test_comment_range_interleaving()` ‚Äî Validates proper interleaving of ranges and references
- All 199 tests pass

**Status:**
Comment threading now works correctly in Word. Debug documents available for manual verification.

## 2026-02-17 - Phase 3 M3.2: CLI --spec and Batch Manifest Flow (Complete)

**What was done:**
- Implemented M3.2: CLI spec and batch generation from Phase 3 PRD (FR-3.2)
- Enhanced `src/docxfix/cli.py` with spec file support:
  - Added `--spec` option to `create` command for loading JSON/YAML specs
  - Created `batch` command for batch generation from manifest files
  - Proper error handling for SpecParseError, ValidationError, and FileNotFoundError
  - Verbose mode shows detailed progress for both commands
- Batch manifest format:
  - YAML file with `fixtures` list containing `id`, `spec`, and `output` fields
  - Spec paths resolved relative to manifest directory
  - Processes all fixtures even if some fail
  - Exit code 1 if any failures, with summary of failed fixtures
  - Handles at least 20 fixtures (tested with 25)
- Created comprehensive test suite (`tests/test_cli_spec.py`) ‚Äî 18 tests:
  - `create --spec` with YAML and JSON
  - Verbose mode, validation controls
  - Complex specs with all features
  - Error cases: invalid spec, missing files
  - Batch command: simple, verbose, multiple fixtures
  - Batch error handling: invalid specs, missing files, malformed manifest
  - Batch validation: 20+ fixtures, relative paths
- Created documentation:
  - `docs/phase-3-guide.md` ‚Äî comprehensive CLI and BDD integration guide
  - Updated `README.md` with new CLI usage examples
  - Created `examples/batch-manifest.yaml` ‚Äî working example manifest
- All acceptance criteria met:
  - ‚úÖ Batch handles 20+ fixtures (tested with 25)
  - ‚úÖ CLI exits non-zero when fixtures fail
  - ‚úÖ Failure output identifies fixture id and input file

**Test coverage:** 18 new CLI tests (198 total, all passing)
- create command: YAML, JSON, verbose, validation, complex specs, errors (7 tests)
- batch command: simple, verbose, errors, validation, many fixtures, relative paths (11 tests)

**Files added:**
- `tests/test_cli_spec.py` ‚Äî CLI spec loading tests
- `docs/phase-3-guide.md` ‚Äî Phase 3 user guide
- `examples/batch-manifest.yaml` ‚Äî example batch manifest

**Files changed:**
- `src/docxfix/cli.py` ‚Äî added --spec option and batch command
- `README.md` ‚Äî updated CLI usage section
- `docs/future-phases-prd.md` ‚Äî marked M3.2 as complete
- `PROGRESS.txt` ‚Äî this entry

**What's ready for next work:**
- M3.3: BDD row mapping helper + tests
- M3.4: Docs/examples cleanup

---

## 2026-02-17 - Phase 3 M3.1: Input Parser + Validation Errors (Complete)

**What was done:**
- Implemented M3.1: External fixture input format from Phase 3 PRD (FR-3.1)
- Created `src/docxfix/input_parser.py` ‚Äî JSON/YAML fixture spec parser:
  - `parse_spec_file(path)` ‚Äî parses `.json`, `.yaml`, `.yml` files into `DocumentSpec`
  - `parse_spec_string(text, format=)` ‚Äî parses raw strings (useful for tests/embedding)
  - `SpecParseError` ‚Äî collects all errors with field paths (e.g. `$.paragraphs[0].text`) and reasons
  - Validates all required fields, type correctness, enum values, ISO datetime formats
  - Collects multiple errors in a single pass (does not stop at the first error)
- All spec features supported: tracked changes, comments with replies, numbering, heading levels, sections with headers/footers, deterministic seed
- Added `pyyaml>=6.0` to project dependencies
- Created 8 example fixture specs in `examples/`:
  - `01-simple.yaml` ‚Äî minimal plain paragraphs
  - `02-tracked-changes.yaml` ‚Äî insertions and deletions
  - `03-comments.yaml` ‚Äî threaded comments with replies, resolved state
  - `04-legal-list-numbering.yaml` ‚Äî multilevel legal-list numbering
  - `05-heading-numbering.yaml` ‚Äî heading-based styled numbering
  - `06-sections.yaml` ‚Äî multiple sections with headers/footers, landscape orientation
  - `07-combined.yaml` ‚Äî tracked changes + comments + numbering together
  - `08-deterministic.json` ‚Äî seeded deterministic output (JSON format)

**Test coverage:** 64 new tests (180 total, all passing)
- YAML happy paths: minimal, title/author, seed, multiple paragraphs (4 tests)
- JSON happy paths: minimal, full document (2 tests)
- Tracked changes: insertion, deletion, revision_id, default author, date parsing (5 tests)
- Comments: simple, with replies, resolved (3 tests)
- Numbering: list numbering, defaults, heading level (3 tests)
- Sections: headers/footers, page numbering (2 tests)
- File parsing: yaml, yml, json extensions, file not found, unsupported extension (5 tests)
- Top-level errors: not object, missing paragraphs, empty paragraphs, wrong types (6 tests)
- Paragraph errors: not object, missing text, heading level out of range (4 tests)
- Tracked change errors: missing change_type, invalid change_type, missing text, not object (4 tests)
- Comment errors: missing text, missing anchor_text, reply missing text, reply not object (4 tests)
- Date errors: invalid format, wrong type (2 tests)
- Section errors: missing start_paragraph, invalid orientation, not object (3 tests)
- Numbering errors: not object, level wrong type (2 tests)
- Multiple errors: collects all errors, error message format (2 tests)
- Malformed input: invalid JSON, invalid YAML, unsupported format (3 tests)
- Example fixtures: all 8 examples parse successfully (8 parametrized tests)
- End-to-end: parsed spec generates valid .docx, combined example generates valid .docx (2 tests)

**Files added:**
- `src/docxfix/input_parser.py` ‚Äî parser module
- `tests/test_input_parser.py` ‚Äî comprehensive test file
- `examples/01-simple.yaml` through `examples/08-deterministic.json` ‚Äî example specs

**Files changed:**
- `pyproject.toml` ‚Äî added pyyaml dependency
- `docs/future-phases-prd.md` ‚Äî marked M3.1 as complete
- `PROGRESS.txt` ‚Äî this entry

**What's ready for next work:**
- M3.2: CLI `--spec` and batch manifest flow ‚Äî wire `parse_spec_file` into the CLI
- M3.3: BDD row mapping helper + tests

---

## 2026-02-17 - Roadmap Specs for Remaining Phases (Planning Update)

**What was done:**
- Expanded `docs/project-outline.md` from a Phase-1-only note into a full roadmap view:
  - Phase 1 and Phase 2 marked complete
  - Next phase focused on BDD-oriented fixture generation only
  - Non-goals tightened to keep project practical (not enterprise workflow tooling)
- Added `docs/future-phases-prd.md` as a lean next-phase spec:
  - **Phase 3:** External input (JSON/YAML), CLI spec/batch workflows, BDD row mapping helpers, runnable examples
  - Analysis/assertion/versioning work explicitly deferred
- Defined acceptance criteria, deliverables, milestones, and success criteria for this reduced scope.

**Why this matters:**
- Aligns the roadmap with the stated goal: straightforward fixture automation for legal-tech BDD workflows.
- Avoids over-building features before there is user demand.

---

## 2026-02-14 - Spec Model Foundation (M1 Complete)

**What was done:**
- Implemented M1: Spec + validation foundation from Phase 1 PRD
- Created core typed spec model in `src/docxfix/spec.py`:
  - DocumentSpec, Paragraph, TrackedChange (insertion/deletion)
  - Comment, CommentReply, NumberedParagraph structures
  - Full type hints and dataclasses
- Created document generator in `src/docxfix/generator.py`:
  - Generates valid .docx (ZIP with OOXML) from spec
  - Basic tracked changes support (insertions/deletions working)
  - Proper namespaces and XML structure
- Created validator in `src/docxfix/validator.py`:
  - ZIP structure validation
  - XML well-formedness checks
  - Error formatting with clear messages
- Updated CLI to actually generate documents:
  - Takes output path
  - Validates by default (--no-validate to skip)
  - Verbose mode for debugging
- Comprehensive tests: 42 tests passing
  - Unit tests for spec models
  - Integration tests for generator
  - Validator tests (happy path + error cases)
  - CLI tests with temp files

**What's ready for next work:**
- Foundation is solid - spec model is flexible and extensible
- Basic tracked changes (FR-1) partially done - insertions/deletions work
- Comment and numbering infrastructure exists in spec but not in generator yet
- Next priority: Complete M2 (tracked changes end-to-end) OR M3 (comments)
  - M2 needs: Golden fixture validation, more complex tracked change scenarios
  - M3 needs: Implement comment generation in DocumentGenerator, add comments.xml part

**Technical notes:**
- Using lxml for XML manipulation (works well)
- .docx structure: ZIP archive with [Content_Types].xml, _rels, word/document.xml minimum
- Tracked changes use w:ins and w:del elements with author/date/id attributes
- Comments will need: comments.xml, commentsExtended.xml, commentsIds.xml parts
- Numbering will need: numbering.xml, styles.xml parts

**Recommendations:**
- For M2: Start by creating a generator method to produce a fixture matching single-insertion.docx
- For M3: Study comment-thread.docx structure, implement multi-part generation
- Consider adding a "from_golden" helper to extract spec from existing .docx for testing

---

## 2026-02-14 - Modern Threaded Comments (M3 Complete)

**What was done:**
- Implemented M3: Comments end-to-end from Phase 1 PRD (FR-2)
- Extended DocumentGenerator with full comment support:
  - Creates comments.xml with comment content and metadata
  - Creates commentsExtended.xml with modern comment features (threading, resolved state)
  - Creates commentsIds.xml with unique identifiers
  - Adds proper comment anchoring in document.xml (commentRangeStart/End/Reference)
- Implemented comment features:
  - Main comments with configurable author, date, text
  - Comment replies with parent linking (paraIdParent attribute)
  - Resolved/unresolved state tracking (w15:done="0"/"1")
  - Anchor text matching to position comments on specific text ranges
  - Handles edge cases (anchor text not found, multiple comments, etc.)
- Added necessary OOXML namespaces:
  - w14 for paragraph IDs
  - w15 for extended comment features
  - w16cid for comment ID tracking
  - mc for markup compatibility
- Updated content types and relationships to include comment parts
- Comprehensive test coverage: +9 tests (51 total, all passing)
  - 5 generator tests for comment scenarios
  - 4 integration tests validating against golden corpus structure
  - Tests cover: simple comments, replies, resolved state, multiple replies, edge cases

**What's validated:**
- Generated comment documents match golden corpus structure:
  - comment-thread.docx pattern (main comment + reply)
  - resolved-comment.docx pattern (resolved state)
- All XML parts are well-formed and validate
- Comment threading relationships are correctly established
- Unique IDs (paraId, durableId) are properly generated using hex strings

**What's ready for next work:**
- M2 (tracked changes end-to-end) - needs golden fixture validation
- M4 (numbering end-to-end) - ready to implement
  - Study legal-list.docx and styled-numbering.docx golden fixtures
  - Implement numbering.xml and styles.xml generation
  - Add multilevel numbering with proper lvl definitions
- Combined scenarios (M5) - can now test comments + tracked changes together

**Technical implementation details:**
- Comment metadata tracking: Store comment info in _comment_metadata list during document generation
- ID generation: _generate_hex_id(8) creates 8-char uppercase hex strings
- Comment anchoring: Split paragraph text into before/anchor/after segments
- Multi-part coordination: comments.xml (content) + commentsExtended.xml (modern features) + commentsIds.xml (IDs)
- Relationship IDs: rId1, rId2, rId3 for comment parts in document.xml.rels

**Known limitations/future work:**
- Currently handles one comment per paragraph (multiple comments create sequential anchors)
- Anchor text must be exact match (no fuzzy matching)
- Comment replies all link to same parent (no nested reply threading beyond 1 level)
- Date formatting is basic ISO format (could enhance with Word-specific formatting)

---

## 2026-02-15 - Namespace Compatibility Fixes for Word Validation

**Problem identified:**
- Generated DOCX files (step3, step4, step5) were requiring "repair" when opened in Microsoft Word
- Files passed internal XML validation but failed Word's stricter requirements
- Issue: Missing comprehensive namespace declarations that Word expects

**What was discovered (corpus comparison):**
- Corpus files (`comment-thread.docx`) contain 30+ namespace declarations in root elements
- Generated files only had 3-6 namespaces (minimal valid OOXML)
- Missing `mc:Ignorable` attribute with comprehensive namespace list
- Affected all comment-related XML files and document.xml

**What was fixed:**
1. **Added WORD_NAMESPACES constant** to `src/docxfix/generator.py`:
   - Comprehensive map with 30+ namespaces matching Word's expectations
   - Includes: wpc, cx1-8, aink, am3d, o, oel, r, m, v, wp14, wp, w10, w, w14, w15, w16cid, w16, etc.

2. **Updated XML generation methods** to use WORD_NAMESPACES:
   - `_create_document()` - document.xml now has full namespace set
   - `_create_comments()` - comments.xml with comprehensive namespaces
   - `_create_comments_extended()` - commentsExtended.xml
   - `_create_comments_ids()` - commentsIds.xml

3. **Added proper mc:Ignorable attributes:**
   - All files now mark optional namespaces: "w14 w15 w16se w16cid w16 w16cex w16sdtdh w16sdtfl w16du wp14"

**Tools created:**
1. `test_progressive_comments.py` - generates 5 minimal test cases:
   - Single comment (no reply)
   - Two separate comments
   - Comment with one reply
   - Resolved comment
   - Comment with multiple replies

2. `Test-DocxFiles.ps1` - PowerShell script for automated Word validation:
   - Opens DOCX files via Word COM automation
   - Reports which files open successfully vs. require repair
   - Useful for CI/CD validation

3. `NAMESPACE_FIXES.md` - comprehensive documentation of:
   - Problem analysis
   - Changes made
   - Next steps for testing
   - Automated testing options

**Status:**
- ‚ö†Ô∏è **Cannot verify fixes** - Project requires Python 3.12+ but system has Python 3.10.11
- Code changes are complete and should resolve namespace issues
- Requires user to:
  1. Install Python 3.12+
  2. Run `test_progressive_comments.py` to regenerate test files
  3. Test files in Word using `Test-DocxFiles.ps1`
  4. Compare XML of any files that still require repair

**Additional areas to investigate if issues persist:**
- RSID attributes (`w:rsidR`, `w:rsidRPr`, `w:rsidRDefault`) - Word's revision save IDs
- Language attributes (`w:lang="en-US"`) on runs
- Proof checking attributes (`w:noProof`) on comment anchor runs
- Comment date/time formatting (currently using basic ISO format)

**Next milestone:**
- M6: Word Compatibility Validation
  - Verify all generated files open in Word without repair prompts
  - Add RSID generation if needed for better Word compatibility
  - Consider adding language and proof attributes to match corpus files exactly

---

## 2026-02-14 - Multilevel Numbering Implementation (M4 Complete)

**What was done:**
- Implemented M4: Numbering end-to-end from Phase 1 PRD (FR-3)
- Extended DocumentGenerator with full multilevel numbering support:
  - Created `_create_numbering()` to generate numbering.xml with legal-style numbering definitions
  - Created `_create_styles()` to generate styles.xml with ListParagraph style
  - Modified `_add_paragraph()` to add paragraph properties (pPr) with numbering properties (numPr)
  - Updated content types and relationships to include numbering.xml and styles.xml
- Implemented legal-style numbering structure:
  - Abstract numbering definition with 9 levels (ilvl 0-8)
  - Decimal number format for all levels
  - Legal-style level text patterns: "%1.", "%1.%2.", "%1.%2.%3.", etc.
  - Proper indentation values (left, hanging) matching Word's behavior:
    - Level 0: left=360, hanging=360
    - Level 1: left=792, hanging=432
    - Level 2: left=1224, hanging=504
    - And so on up to level 8
  - Concrete num element linking to abstract numbering
- Updated NumberedParagraph spec:
  - Removed redundant `text` field (text is in Paragraph)
  - Now only contains numbering properties: level and numbering_id
- Comprehensive test coverage: +12 tests (75 total, all passing)
  - 7 generator tests (numbering XML structure, styles, content types, rels, mixed content)
  - 5 integration tests (legal-list fixture, format patterns, indentation, comments interaction)
- Generated fixtures match golden corpus structure:
  - legal-list.docx pattern validated
  - Correct numId, ilvl, pStyle elements in document.xml
  - Proper abstractNum and num definitions in numbering.xml
  - ListParagraph style in styles.xml

**What's validated:**
- All 63 tests passing (51 original + 12 new numbering tests)
- Numbering works with and without comments
- Mixed numbered and plain paragraphs supported
- Multilevel nesting up to 9 levels
- XML structure matches golden corpus expectations

**What's ready for next work:**
- M2 (tracked changes end-to-end) - basic implementation exists, needs golden fixture validation
- M5 (integration hardening + docs) - ready to start
  - Combined fixture scenarios (numbering + comments + tracked changes)
  - Compatibility lane/checklist baseline run
  - Publish Phase 1 user/developer docs

**Technical implementation details:**
- Numbering and styles parts only generated when paragraphs with numbering are present
- Relationship IDs adjust based on presence of comments (rId1/rId2 without comments, rId4/rId5 with comments)
- ListParagraph style includes basedOn Normal, contextualSpacing, and proper UI priority
- Numbering follows OOXML spec with w:abstractNum pointing to w:num via abstractNumId
- All namespaces properly registered (w, w15, w16cid, mc)

**Recommendations for next implementer:**
- For M2: Create golden fixture comparison tests for tracked changes
- For M5: Test combined scenarios (numbering + tracked changes + comments in same document)
- Consider adding support for different numbering formats (upperRoman, lowerLetter, etc.) in Phase 2
- Think about numbering restart capability (currently all lists share same counter)

---

## 2026-02-15 - Comment Threading Investigation: commentsIds.xml Removal

**Problem being investigated:**
- Generated DOCX files contain comment threading metadata but Microsoft Word doesn't recognize it
- Comment replies appear as separate independent comments instead of threaded/nested
- Comments marked as resolved don't show resolved status in Word
- However, SuperDoc word processor DOES correctly thread comments and recognize resolved status

**Key discovery from SuperDoc testing:**
- SuperDoc correctly threads our generated comments (shows replies nested under parent)
- SuperDoc correctly recognizes resolved comments (they don't appear in UI)
- When SuperDoc saves files, it does NOT create commentsIds.xml entries
- SuperDoc source code only creates commentsIds.xml when commentsExtensible.xml is present

**What was changed:**
- Removed commentsIds.xml file generation entirely from DocumentGenerator
- Removed commentsIds.xml content type entry from [Content_Types].xml
- Removed commentsIds.xml relationship from word/_rels/document.xml.rels
- Adjusted relationship IDs: numbering now uses rId3 (was rId4), styles uses rId4 (was rId5) when comments present
- Updated all tests to not check for commentsIds.xml presence
- Removed test_generator_comment_ids_unique test entirely

**Changes committed:**
- src/docxfix/generator.py - commentsIds.xml removal and ID adjustments
- tests/test_generator.py - removed commentsIds assertions
- tests/test_comment_integration.py - removed commentsIds structure checks  
- tests/test_numbering_integration.py - updated expected relationship IDs (rId3/rId4 instead of rId4/rId5)

**Test results:**
- ‚úÖ All 61 tests pass (1 pre-existing unrelated failure in styles.xml test)
- ‚úÖ Generated files are valid OOXML
- ‚úÖ XML structure remains correct

**Status:**
- ‚ö†Ô∏è **AWAITING VERIFICATION** - Need to test if this fixes Word threading/resolved recognition
- Generated new test files in scratch_out/ for manual Word verification
- If Word still doesn't thread correctly, see COMMENT_THREADING_STATUS.md for next investigation steps

**Hypothesis:**
- SuperDoc working without commentsIds.xml suggests Word might not need it either
- commentsIds.xml may have been red herring or Word-specific compatibility layer
- Core threading metadata is in commentsExtended.xml (paraIdParent, done attributes)

**Next steps:**
1. Open scratch_out/test3-comment-with-reply.docx in Word - check if replies now thread
2. Open scratch_out/test4-resolved-comment.docx in Word - check if comment shows as resolved
3. If still broken, investigate other differences (RSIDs, language tags, date formats)
4. See COMMENT_THREADING_STATUS.md for comprehensive debugging plan

---

## 2026-02-15 - Tracked Changes End-to-End (M2 Complete)

**What was done:**
- Completed M2: Tracked changes end-to-end from Phase 1 PRD (FR-1)
- Enhanced `TrackedChange` spec with `insert_after` field for positioning insertions within paragraph text
- Rewrote tracked change generation in `DocumentGenerator`:
  - New `_add_paragraph_with_tracked_changes()` method interleaves plain text runs with tracked change elements
  - Deletions are located by finding `change.text` as a substring of the paragraph text
  - Insertions are positioned using `insert_after` to find the anchor point
  - Events are sorted by position and emitted in document order
  - Legacy behaviour preserved: empty paragraph text ‚Üí changes emitted standalone
- New `_add_text_run()` helper emits plain runs with `xml:space="preserve"` when text has leading/trailing whitespace
- Renamed internal `_add_tracked_change()` to `_emit_tracked_change()` (now only responsible for emitting the XML element, not positioning)
- Added `xml:space="preserve"` on `w:t` and `w:delText` inside tracked changes when whitespace present

**Test coverage:** +10 tests (71 total, all passing; 1 pre-existing styles.xml failure excluded)
- 3 golden corpus structure tests (verify single-insertion.docx, single-deletion.docx, mixed-insert-delete.docx)
- 4 generator tests matching corpus patterns (single insertion, single deletion, mixed, unique IDs)
- 3 additional tests (validation, legacy behaviour, xml:space preserve)

**Files changed:**
- `src/docxfix/spec.py` - Added `insert_after` field to TrackedChange
- `src/docxfix/generator.py` - New `_add_paragraph_with_tracked_changes()`, `_add_text_run()`, `_emit_tracked_change()` methods
- `tests/test_tracked_change_integration.py` - New integration test file
- `docs/phase-1-prd.md` - Marked M2 as complete

**What's ready for next work:**
- M5 (Integration hardening + docs) - the final milestone
  - Combined fixture scenarios (numbering + comments + tracked changes in same document)
  - Compatibility lane/checklist baseline run
  - Publish Phase 1 user/developer docs
- Pre-existing styles.xml test failure in `test_numbering_generator.py::test_styles_xml_structure` should be investigated

---

## 2026-02-16 - Combined Tracked Changes + Comments Fix (M5 Partial)

**What was done:**
- Fixed critical bug: paragraphs with both `comments` and `tracked_changes` only took the comments path due to `if/elif` dispatch, silently dropping tracked changes
- Added `_add_paragraph_with_comments_and_tracked_changes()` method to generator.py:
  - Merges comment anchoring and tracked-change positioning in a single walk over the base text
  - Collects events (comment_start, comment_end, ins, del) with their text positions
  - Sorts events by position with proper priority ordering (comment_start < ins < del < comment_end)
  - Emits plain text runs, comment markers, and tracked change elements in correct document order
- Updated dispatch in `_add_paragraph()` to check for combined case first
- Included two pre-existing unstaged fixes:
  - Added `basedOn` element to ListParagraph style in `_create_styles()` (fixes styles.xml test)
  - Replaced deprecated `datetime.utcnow()` with `datetime.now(timezone.utc)`

**Test results:**
- ‚úÖ All 81 tests passing (78 previously passing + 3 previously failing combined integration tests)
- 9 combined integration tests all pass:
  - test_tracked_changes_and_comments_in_same_paragraph
  - test_tracked_changes_and_comments_across_paragraphs
  - test_tracked_changes_in_numbered_paragraph
  - test_comments_on_numbered_paragraphs
  - test_all_features_combined
  - test_all_features_combined_validates
  - test_content_types_include_all_parts
  - test_relationships_include_all_parts
  - test_unique_ids_across_features

**Files changed:**
- `src/docxfix/generator.py` - new combined method + dispatch fix + unstaged fixes
- `docs/phase-1-prd.md` - updated M5 status
- `PROGRESS.txt` - this entry

**What's remaining for M5:**
- Compatibility lane/checklist baseline run
- Publish Phase 1 user/developer docs

---

## 2026-02-16 - Heading-Based (Styled) Numbering Support

**What was done:**
- Added heading-based numbering as an alternative to legal-list numbering
- This implements the "styled-numbering" pattern seen in corpus/styled-numbering.docx
- Key structural difference: paragraphs get `pStyle=HeadingN` only, no explicit `numPr`; numbering linkage lives in style definitions

**Spec changes (spec.py):**
- Added `heading_level: int | None` field to `Paragraph` (values 1-4 ‚Üí Heading1-Heading4)
- Added `heading_level` parameter to `DocumentSpec.add_paragraph()`

**Generator changes (generator.py):**
- `generate()` detects `has_heading_numbering` alongside `has_numbering`; both trigger styles/numbering parts
- `_add_paragraph()` emits `<w:pStyle w:val="HeadingN"/>` with no `numPr` for heading paragraphs
- `_create_numbering()` refactored: extracted `_add_list_abstract_num()` and `_add_heading_abstract_num()`
  - Heading abstractNum has 4 levels with pStyle back-references (Heading1-Heading4)
  - Level formats: decimal "%1", decimal "%2.%1", lowerLetter "(%3)", lowerRoman "(%4)"
  - Uses separate numId (2 when list numbering coexists, 1 when standalone)
- `_create_styles()` accepts `has_heading_numbering` flag; calls `_add_heading_styles()`
  - Heading1-4 styles: basedOn Normal, keepNext/keepLines, embedded numPr, outlineLvl
  - Plausible formatting: major theme fonts, bold for H1-H2, decreasing font sizes

**Coexistence:**
- List numbering (numId=1, abstractNumId=0) and heading numbering (numId=2, abstractNumId=1) work together
- Each type uses its own abstractNum/num pair; no collisions

**Test coverage (tests/test_heading_numbering.py):** 11 tests
- Paragraph emission: pStyle only, no numPr in document.xml (2 tests)
- styles.xml: Heading1-4 definitions with numPr and formatting (2 tests)
- numbering.xml: pStyle back-references, correct numFmt/lvlText (2 tests)
- Coexistence: list + heading numbering in same document (1 test)
- Combined with comments and tracked changes (2 tests)
- Validation passes (2 tests)

**Test results:** ‚úÖ All 92 tests passing (81 existing + 11 new)

**Files changed:**
- `src/docxfix/spec.py` - heading_level field
- `src/docxfix/generator.py` - paragraph emission, styles, numbering
- `tests/test_heading_numbering.py` - new test file
- `docs/phase-1-prd.md` - noted heading numbering under M5
- `PROGRESS.txt` - this entry

---

## 2026-02-16 - Phase 1 User/Developer Documentation (M5 Partial)

**What was done:**
- Created `docs/phase-1-guide.md` ‚Äî the Phase 1 user and developer documentation
- Covers all deliverable 7 items from the PRD:
  - **Usage guide:** CLI commands, Python API walkthrough (spec ‚Üí generator ‚Üí ZIP)
  - **Spec examples:** tracked-change-heavy contract, comment-threaded review doc, legal clause hierarchy
  - **API reference:** complete field tables for TrackedChange, Comment, CommentReply, NumberedParagraph
  - **Known limitations:** documented per feature family (tracked changes, comments, numbering, general)
  - **Compatibility checklist:** automated (CI) and manual (Word verification) items
  - **Architecture overview:** module responsibilities and conditional OOXML parts
- Corpus format guide already existed at `corpus/README.md`
- Updated PRD M5 status to reflect docs completion

**Test results:** All 92 tests passing (no changes to code)

**Files changed:**
- `docs/phase-1-guide.md` - new Phase 1 documentation
- `docs/phase-1-prd.md` - updated M5 status
- `PROGRESS.txt` - this entry

**What's remaining for M5:**
- Compatibility lane/checklist baseline run (manual Word verification)
- Once that's done, M5 is complete and Phase 1 PRD is fully delivered

---

## 2026-02-17 - Phase 2: Code Quality & Hardening (Complete)

**What was done:**

Phase 2 refactored the 1618-line generator monolith into maintainable sub-modules, strengthened validation, added snapshot tests, wired deterministic seed, and cleaned up docs.

**M1: Extract constants and boilerplate**
- Created `src/docxfix/constants.py` (NAMESPACES, WORD_NAMESPACES, XML string constants)
- Created `src/docxfix/boilerplate.py` (stateless part generators)

**M2: Extract feature modules**
- Created `src/docxfix/parts/` package with 6 modules:
  - `context.py` (GeneratorContext dataclass)
  - `comments.py`, `tracked_changes.py`, `numbering.py`, `styles.py`, `sections.py`
- `generator.py` reduced from 1618 to ~620 lines

**M3: Enhanced validation**
- Added 5 semantic checks: comment ID uniqueness, tracked change ID uniqueness, comment anchor integrity, relationship completeness, content type coverage
- 7 new tests

**M4: Snapshot tests with syrupy**
- 5 snapshot tests for key XML parts (document.xml, comments.xml, numbering.xml, styles.xml, [Content_Types].xml)

**M5: Wire deterministic seed**
- `GeneratorContext` uses `random.Random(seed)` instance (no global state pollution)
- Spec datetimes fixed to reference datetime when seeded
- `create_core_properties()` accepts optional fixed timestamp
- Byte-identical output verified with 3 new tests

**M6: Cleanup and docs update**
- Removed unused imports
- Updated `docs/phase-1-guide.md` with sections, deterministic seed, validation details
- Created `docs/phase-2-prd.md`

**Test results:** 116 tests passing (101 Phase 1 + 15 new)


---

## 2026-02-26 - Phase 3 M3.4: Docs/Examples Cleanup (Complete)

**What was done:**

- Created xamples/bdd_row_example.py ‚Äî standalone runnable Python script showing the full BDD row -> spec -> docx workflow using map_row_to_spec. Demonstrates 5 scenario table rows (tracked-only, comments-only, numbered-list, with-sections, full-featured).
- Created 	ests/test_examples_smoke.py ‚Äî CI smoke checks:
  - Parametrized test for each of the 8 bundled example specs via CLI create --spec
  - Batch manifest smoke test (all 8 fixtures succeed via xamples/batch-manifest.yaml)
  - Subprocess test that runs dd_row_example.py end-to-end
- Updated docs/phase-3-guide.md:
  - Replaced stale "Scenario Tables" placeholder with actual dd_mapping usage (alias table, code example)
  - Updated "Next Steps" to reflect Phase 3 completion
- Updated docs/future-phases-prd.md ‚Äî M3.4 marked Complete

**Test results:** 260 tests passing (250 existing + 10 new smoke tests)
